<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
<title>PyMC3 extras &mdash; exoplanet 0.3.1.dev1+gc54f7b4 documentation</title>
  

<link rel="shortcut icon" href="../../_static/logo.png"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"><link rel="stylesheet" href="../../_static/typlog.css?v=0.7.3" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme.css?v=0.7.3" type="text/css" /><link rel="stylesheet" href="../../_static/css/exoplanet.css?v=2020-01-15" type="text/css" />
      <link rel="index" title="Index" href="../../genindex/"/>
      <link rel="search" title="Search" href="../../search/"/>
    <link rel="top" title="exoplanet 0.3.1.dev1+gc54f7b4 documentation" href="../../"/>
      <link rel="next" title="Radial velocity fitting" href="../rv/"/>
      <link rel="prev" title="A quick intro to PyMC3 for exoplaneteers" href="../intro-to-pymc3/"/>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create', '');ga('send', 'pageview');</script>
  <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  <meta property="og:type" content="website">
  <meta property="og:site_name" content="exoplanet">
  <meta property="og:title" content="PyMC3 extras">
  <meta name="twitter:card" content="summary">
<script src="https://kit.fontawesome.com/12d959964a.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/mustache@latest"></script>
<script>
    $.ajax({
        dataType: "json",
        url: "https://raw.githubusercontent.com/exoplanet-dev/exoplanet/gh-pages/versions.json",
        success: function (data) {
            var versions = Object.keys(data).sort();
            $(function render() {
                var template = document.getElementById('versions-template').innerHTML;
                var rendered = Mustache.render(template, { versions: versions });
                document.body.innerHTML += rendered;
                $(".current-version").click(function () {
                    $(".versions-dropdown").toggle();
                });
            });
        }
    });
</script>

</head>
<body role="document" data-page="tutorials/pymc3-extras">
  <header class="t-head">
    <div class="t-head_menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M64 384h384v-42.666H64V384zm0-106.666h384v-42.667H64v42.667zM64 128v42.665h384V128H64z"/></svg></div>
    <a class="t-head_logo" href="../../"><img src="../../_static/logo.png" alt="Logo"/>exoplanet
    </a>
  </header>
  <aside class="t-sidebar">
    <div class="t-sidebar_close">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M405 136.798L375.202 107 256 226.202 136.798 107 107 136.798 226.202 256 107 375.202 136.798 405 256 285.798 375.202 405 405 375.202 285.798 256z"/></svg>
    </div>
    <div class="inner">
<a class="logo" href="../../"><img src="../../_static/logo.png" alt="Logo"/>
    exoplanet
</a><div class="globaltoc">
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/install/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citation/">Citing exoplanet &amp; its dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/api/">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/dev/">Developer documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro-to-pymc3/">A quick intro to PyMC3 for exoplaneteers</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">PyMC3 extras</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dense-mass-matrices">Dense mass matrices</a></li>
<li class="toctree-l2"><a class="reference internal" href="#evaluating-model-components-for-specific-samples">Evaluating model components for specific samples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rv/">Radial velocity fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transit/">Transit fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../astrometric/">Astrometric fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gp/">Scalable Gaussian processes in PyMC3</a></li>
</ul>

</div><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../">Documentation overview</a><ul>
      <li>Previous: <a href="../intro-to-pymc3/" title="previous chapter">A quick intro to PyMC3 for exoplaneteers</a></li>
      <li>Next: <a href="../rv/" title="next chapter">Radial velocity fitting</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox">
  <form class="search" action="../../search/" method="get">
    <div class="input-group">
      <input type="text" name="q" placeholder="Search" />
      <button type="submit">Go</button>
    </div>
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    </div>
  </aside>
  <div class="t-content">
    <div class="t-body yue">
      


  <span class="target" id="module-exoplanet"></span><div class="admonition note">
<p class="admonition-title">Note</p>
<p>This tutorial was generated from an IPython notebook that can be
downloaded <a class="reference external" href="../../_static/notebooks/pymc3-extras.ipynb">here</a>.</p>
</div>
<div class="section" id="pymc3-extras">
<span id="id1"></span><h1>PyMC3 extras<a class="headerlink" href="#pymc3-extras" title="Permalink to this headline">¶</a></h1>
<p><em>exoplanet</em> comes bundled with a few utilities that can make it easier
to use and debug PyMC3 models for fitting exoplanet data. This tutorial
briefly describes these features and their use.</p>
<div class="section" id="dense-mass-matrices">
<h2>Dense mass matrices<a class="headerlink" href="#dense-mass-matrices" title="Permalink to this headline">¶</a></h2>
<p>The main extra is the <a class="reference internal" href="../../user/api/#exoplanet.get_dense_nuts_step" title="exoplanet.get_dense_nuts_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">exoplanet.get_dense_nuts_step()</span></code></a> function
that extends the PyMC3 sampling procedure to include support for
learning off-diagonal elements of the mass matrix. This is <em>very</em>
important for any problems where there are covariances between the
parameters (this is true for pretty much all exoplanet models). A
thorough discussion of this <a class="reference external" href="https://dfm.io/posts/pymc3-mass-matrix/">can be found elsewhere
online</a>, but here is a
simple demo where we sample a covariant Gaussian using
<a class="reference internal" href="../../user/api/#exoplanet.get_dense_nuts_step" title="exoplanet.get_dense_nuts_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">exoplanet.get_dense_nuts_step()</span></code></a>.</p>
<p>First, we generate a random positive definite covariance matrix for the
Gaussian:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">ndim</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>
<span class="n">L</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag_indices_from</span><span class="p">(</span><span class="n">L</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag_indices_from</span><span class="p">(</span><span class="n">L</span><span class="p">)])</span>
<span class="n">L</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices_from</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
<p>And then we can sample this using PyMC3 and
<a class="reference internal" href="../../user/api/#exoplanet.get_dense_nuts_step" title="exoplanet.get_dense_nuts_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">exoplanet.get_dense_nuts_step()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">exoplanet</span> <span class="k">as</span> <span class="nn">xo</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">MvNormal</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">),</span> <span class="n">chol</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ndim</span><span class="p">,))</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">draws</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">xo</span><span class="o">.</span><span class="n">get_dense_nuts_step</span><span class="p">()</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Multiprocess sampling (2 chains in 2 jobs)
NUTS: [x]
Sampling 2 chains, 0 divergences: 100%|██████████| 8000/8000 [00:14&lt;00:00, 570.71draws/s]
</pre></div>
</div>
<p>This is a little more verbose than the standard use of PyMC3, but the
performance is several orders of magnitude better than you would get
without the mass matrix tuning. As you can see from the
<code class="docutils literal notranslate"><span class="pre">pymc3.summary</span></code>, the autocorrelation time of this chain is about 1 as
we would expect for a simple problem like this.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hpd_3%</th>
      <th>hpd_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_mean</th>
      <th>ess_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>x[0]</th>
      <td>0.003</td>
      <td>0.163</td>
      <td>-0.312</td>
      <td>0.295</td>
      <td>0.002</td>
      <td>0.002</td>
      <td>6710.0</td>
      <td>2141.0</td>
      <td>6707.0</td>
      <td>3249.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>x[1]</th>
      <td>-0.009</td>
      <td>0.539</td>
      <td>-0.964</td>
      <td>1.028</td>
      <td>0.006</td>
      <td>0.008</td>
      <td>6956.0</td>
      <td>2143.0</td>
      <td>6959.0</td>
      <td>3373.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>x[2]</th>
      <td>-0.005</td>
      <td>0.679</td>
      <td>-1.166</td>
      <td>1.361</td>
      <td>0.008</td>
      <td>0.011</td>
      <td>6934.0</td>
      <td>2012.0</td>
      <td>6986.0</td>
      <td>3226.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>x[3]</th>
      <td>-0.004</td>
      <td>1.224</td>
      <td>-2.274</td>
      <td>2.308</td>
      <td>0.015</td>
      <td>0.019</td>
      <td>6974.0</td>
      <td>2021.0</td>
      <td>7018.0</td>
      <td>3073.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>x[4]</th>
      <td>0.032</td>
      <td>2.102</td>
      <td>-3.675</td>
      <td>4.216</td>
      <td>0.027</td>
      <td>0.035</td>
      <td>5854.0</td>
      <td>1854.0</td>
      <td>5856.0</td>
      <td>2975.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="evaluating-model-components-for-specific-samples">
<h2>Evaluating model components for specific samples<a class="headerlink" href="#evaluating-model-components-for-specific-samples" title="Permalink to this headline">¶</a></h2>
<p>I find that when I’m debugging a PyMC3 model, I often want to inspect
the value of some part of the model for a given set of parameters. As
far as I can tell, there isn’t a simple way to do this in PyMC3, so
<em>exoplanet</em> comes with a hack for doing this:
<a class="reference internal" href="../../user/api/#exoplanet.eval_in_model" title="exoplanet.eval_in_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">exoplanet.eval_in_model()</span></code></a>. This function handles the mapping
between named PyMC3 variables and the input required by the Theano
function that can evaluate the requested variable or tensor.</p>
<p>As a demo, let’s say that we’re fitting a parabola to some data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=-</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">a0</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;a0&quot;</span><span class="p">)</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;a1&quot;</span><span class="p">)</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;a2&quot;</span><span class="p">)</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># Sample from the prior</span>
    <span class="n">prior_sample</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_prior_predictive</span><span class="p">(</span><span class="n">samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">prior_sample</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">prior_sample</span><span class="p">[</span><span class="s2">&quot;logs&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

    <span class="c1"># Add the likelihood</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mod</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span> <span class="n">observed</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># Fit the data</span>
    <span class="n">map_soln</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [a2, a1, a0, logs]
26it [00:00, 575.25it/s, logp=4.272312e+01]
message: Optimization terminated successfully.
logp: -180.51036900636572 -&gt; 42.72311721910288
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 2 jobs)
NUTS: [a2, a1, a0, logs]
Sampling 2 chains, 0 divergences: 100%|██████████| 2000/2000 [00:02&lt;00:00, 896.87draws/s]
</pre></div>
</div>
<p>After running the fit, it might be interesting to look at the
predictions of the model. We could have added a <code class="docutils literal notranslate"><span class="pre">pymc3.Deterministic</span></code>
node for eveything, but that can end up taking up a lot of memory and
sometimes its useful to be able to experiement with different outputs.
Using <code class="xref py py-func docutils literal notranslate"><span class="pre">exoplanet.utils.eval_in_model()</span></code> we can, for example,
evaluate the maximum a posteriori (MAP) model prediction on a fine grid:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span><span class="n">a0</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">x_grid</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">x_grid</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">map_soln</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;.k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;map&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/pymc3-extras_12_0.png" src="../../_images/pymc3-extras_12_0.png" />
<p>We can also combine this with <a class="reference internal" href="../../user/api/#exoplanet.get_samples_from_trace" title="exoplanet.get_samples_from_trace"><code class="xref py py-func docutils literal notranslate"><span class="pre">exoplanet.get_samples_from_trace()</span></code></a>
to plot this prediction for a set of samples in the trace.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)))</span>
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">y_grid</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">x_grid</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">x_grid</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xo</span><span class="o">.</span><span class="n">get_samples_from_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">50</span><span class="p">)):</span>
        <span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span><span class="n">y_grid</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;.k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;map&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;posterior&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">samples</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/pymc3-extras_14_0.png" src="../../_images/pymc3-extras_14_0.png" />
</div>
</div>

  <div class="t-pagination clearfix">
    <span>
      ← <a href="../intro-to-pymc3/" title="A quick intro to PyMC3 for exoplaneteers">A quick intro to PyMC3 for...</a>
    </span>
    <span style="float:right">
      <a href="../rv/" title="Radial velocity fitting">Radial velocity fitting</a> →
    </span>
  </div>


    </div>
<footer class="t-foot">
    &copy; Copyright 2018, 2019, 2020, Dan Foreman-Mackey.
    <br>
    A <a href="https://typlog.com/">typlog</a> <a href="https://github.com/typlog/sphinx-typlog-theme">sphinx theme</a>,
    designed by <a href="https://lepture.com/">Hsiaoming Yang</a>.
</footer>

<script id="versions-template" type="x-tmpl-mustache">
<div class="versions">
    <div class="current-version">
        move-tests
        <span class="fas fa-caret-down"></span>
    </div>
    <dl class="versions-dropdown">
        {{#versions}}
        <dd><a href="https://docs.exoplanet.codes/en/{{.}}/tutorials/pymc3-extras">{{.}}</a></dd>
        {{/versions}}
    </dl>
</div>
</script>

  </div>
  <script>$(function(){$(".t-head_menu").on("click",function(){$("body").addClass("_expand")});$(".t-body").on("click",function(){$("body").removeClass("_expand")});$(".t-sidebar_close").on("click",function(){$("body").removeClass("_expand")});$("a.footnote-reference").on("click",function(e){e.preventDefault();var id=$(this).attr("href");var html=$(id).find("td.label + td").html();var w=Math.max(document.documentElement.clientWidth,window.innerWidth||0);var style="top:"+e.pageY+"px;";if(w>560){style+="width:480px;";if(e.pageX>240&&e.pageX+240<w){style+="left:"+(e.pageX-240)+"px;"}else if(e.pageX<=240){style+="left:20px;"}else{style+="right:20px;"}}showFootnote(html,style)});function showFootnote(html,style){var CONTENT_ID="typlog-footnote-content";var content=document.getElementById(CONTENT_ID);if(!content){content=document.createElement("div");content.id=CONTENT_ID;$(".t-body").append(content)}var MASK_ID="typlog-footnote-mask";var mask=document.getElementById(MASK_ID);if(!mask){mask=document.createElement("div");mask.id=MASK_ID;document.body.appendChild(mask);mask.addEventListener("click",function(){content.className="";mask.className=""})}content.innerHTML=html;content.setAttribute("style",style);content.className="_active";mask.className="_active"}function fetchGitHubRepo(repo){var url="https://api.github.com/repos/"+repo;$.getJSON(url,function(data){var counts=[+new Date,data.stargazers_count,data.forks_count];localStorage.setItem("gh:"+repo,JSON.stringify(counts));updateGitHubStats(counts[1],counts[2])})}function updateGitHubStats(stars,forks){$(".github_stars strong").text(stars);$(".github_forks strong").text(forks)}function initGitHub(url){if(!url){return}var repo=url.replace("https://github.com/","");var cache=localStorage.getItem("gh:"+repo);if(cache){try{var counts=JSON.parse(cache);updateGitHubStats(counts[1],counts[2]);var delta=new Date-counts[0];if(delta<0||delta>9e5){fetchGitHubRepo(repo)}}catch(error){fetchGitHubRepo(repo)}}else{fetchGitHubRepo(repo)}}initGitHub($(".github").attr("href"))});</script>
</body>
</html>