<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
<title>Radial velocity fitting &mdash; exoplanet 0.3.1 documentation</title>
  

<link rel="shortcut icon" href="../../_static/logo.png"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"><link rel="stylesheet" href="../../_static/typlog.css?v=0.7.3" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme.css?v=0.7.3" type="text/css" /><link rel="stylesheet" href="../../_static/css/exoplanet.css?v=2020-01-15" type="text/css" />
      <link rel="index" title="Index" href="../../genindex/"/>
      <link rel="search" title="Search" href="../../search/"/>
    <link rel="top" title="exoplanet 0.3.1 documentation" href="../../"/>
      <link rel="next" title="Transit fitting" href="../transit/"/>
      <link rel="prev" title="PyMC3 extras" href="../pymc3-extras/"/>
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create', '');ga('send', 'pageview');</script>
  <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  <meta property="og:type" content="website">
  <meta property="og:site_name" content="exoplanet">
  <meta property="og:title" content="Radial velocity fitting">
  <meta name="twitter:card" content="summary">
<script src="https://kit.fontawesome.com/12d959964a.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/mustache@latest"></script>
<script>
    $.ajax({
        dataType: "json",
        url: "https://raw.githubusercontent.com/exoplanet-dev/exoplanet/gh-pages/versions.json",
        success: function (data) {
            var versions = Object.keys(data).sort();
            $(function render() {
                var template = document.getElementById('versions-template').innerHTML;
                var rendered = Mustache.render(template, { versions: versions });
                document.body.innerHTML += rendered;
                $(".current-version").click(function () {
                    $(".versions-dropdown").toggle();
                });
            });
        }
    });
</script>

</head>
<body role="document" data-page="tutorials/rv">
  <header class="t-head">
    <div class="t-head_menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M64 384h384v-42.666H64V384zm0-106.666h384v-42.667H64v42.667zM64 128v42.665h384V128H64z"/></svg></div>
    <a class="t-head_logo" href="../../"><img src="../../_static/logo.png" alt="Logo"/>exoplanet
    </a>
  </header>
  <aside class="t-sidebar">
    <div class="t-sidebar_close">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M405 136.798L375.202 107 256 226.202 136.798 107 107 136.798 226.202 256 107 375.202 136.798 405 256 285.798 375.202 405 405 375.202 285.798 256z"/></svg>
    </div>
    <div class="inner">
<a class="logo" href="../../"><img src="../../_static/logo.png" alt="Logo"/>
    exoplanet
</a><div class="globaltoc">
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/install/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citation/">Citing exoplanet &amp; its dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/api/">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/dev/">Developer documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro-to-pymc3/">A quick intro to PyMC3 for exoplaneteers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pymc3-extras/">PyMC3 extras</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Radial velocity fitting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-radial-velocity-model-in-pymc3">The radial velocity model in PyMC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sampling">Sampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#phase-plots">Phase plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="#citations">Citations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../transit/">Transit fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../astrometric/">Astrometric fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gp/">Scalable Gaussian processes in PyMC3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../light-delay/">Light travel time delay</a></li>
</ul>

</div><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../">Documentation overview</a><ul>
      <li>Previous: <a href="../pymc3-extras/" title="previous chapter">PyMC3 extras</a></li>
      <li>Next: <a href="../transit/" title="next chapter">Transit fitting</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox">
  <form class="search" action="../../search/" method="get">
    <div class="input-group">
      <input type="text" name="q" placeholder="Search" />
      <button type="submit">Go</button>
    </div>
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    </div>
  </aside>
  <div class="t-content">
    <div class="t-body yue">
      


  <span class="target" id="module-exoplanet"></span><div class="admonition note">
<p class="admonition-title">Note</p>
<p>This tutorial was generated from an IPython notebook that can be
downloaded <a class="reference external" href="../../_static/notebooks/rv.ipynb">here</a>.</p>
</div>
<div class="section" id="radial-velocity-fitting">
<span id="rv"></span><h1>Radial velocity fitting<a class="headerlink" href="#radial-velocity-fitting" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial, we will demonstrate how to fit radial velocity
observations of an exoplanetary system using <em>exoplanet</em>. We will follow
<a class="reference external" href="https://radvel.readthedocs.io/en/latest/tutorials/K2-24_Fitting+MCMC.html">the getting started
tutorial</a>
from <a class="reference external" href="https://radvel.readthedocs.io">the exellent RadVel package</a>
where they fit for the parameters of the two planets in <a class="reference external" href="https://arxiv.org/abs/1511.04497">the K2-24
system</a>.</p>
<p>First, let’s download the data from RadVel:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/California-Planet-Search/radvel/master/example_data/epic203771098.csv&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">vel</span><span class="p">)</span>
<span class="n">yerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">errvel</span><span class="p">)</span>

<span class="c1"># Compute a reference time that will be used to normalize the trends model</span>
<span class="n">x_ref</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="c1"># Also make a fine grid that spans the observation window for plotting purposes</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time [days]&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;radial velocity [m/s]&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/rv_4_0.png" src="../../_images/rv_4_0.png" />
<p>Now, we know the periods and transit times for the planets <a class="reference external" href="https://arxiv.org/abs/1511.04497">from the K2
light curve</a>, so let’s start by
using the <code class="xref py py-func docutils literal notranslate"><span class="pre">exoplanet.estimate_semi_amplitude()</span></code> function to
estimate the expected RV semi-amplitudes for the planets.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">exoplanet</span> <span class="k">as</span> <span class="nn">xo</span>

<span class="n">periods</span> <span class="o">=</span> <span class="p">[</span><span class="mf">20.8851</span><span class="p">,</span> <span class="mf">42.3633</span><span class="p">]</span>
<span class="n">period_errs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0003</span><span class="p">,</span> <span class="mf">0.0006</span><span class="p">]</span>
<span class="n">t0s</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2072.7948</span><span class="p">,</span> <span class="mf">2082.6251</span><span class="p">]</span>
<span class="n">t0_errs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0007</span><span class="p">,</span> <span class="mf">0.0004</span><span class="p">]</span>
<span class="n">Ks</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">estimate_semi_amplitude</span><span class="p">(</span><span class="n">periods</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="p">,</span> <span class="n">t0s</span><span class="o">=</span><span class="n">t0s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Ks</span><span class="p">,</span> <span class="s2">&quot;m/s&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mf">5.05069163</span> <span class="mf">5.50983542</span><span class="p">]</span> <span class="n">m</span><span class="o">/</span><span class="n">s</span>
</pre></div>
</div>
<div class="section" id="the-radial-velocity-model-in-pymc3">
<h2>The radial velocity model in PyMC3<a class="headerlink" href="#the-radial-velocity-model-in-pymc3" title="Permalink to this headline">¶</a></h2>
<p>Now that we have the data and an estimate of the initial values for the
parameters, let’s start defining the probabilistic model in PyMC3 (take
a look at <a class="reference internal" href="../intro-to-pymc3/#intro-to-pymc3"><span class="std std-ref">A quick intro to PyMC3 for exoplaneteers</span></a> if you’re new to PyMC3). First, we’ll
define our priors on the parameters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="k">as</span> <span class="nn">tt</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>

    <span class="c1"># Gaussian priors based on transit data (from Petigura et al.)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;t0&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t0s</span><span class="p">),</span> <span class="n">sd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t0_errs</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Bound</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span>
        <span class="s2">&quot;P&quot;</span><span class="p">,</span>
        <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">periods</span><span class="p">),</span>
        <span class="n">sd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">period_errs</span><span class="p">),</span>
        <span class="n">shape</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">testval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">periods</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Wide log-normal prior for semi-amplitude</span>
    <span class="n">logK</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Bound</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span>
        <span class="s2">&quot;logK&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Ks</span><span class="p">),</span> <span class="n">sd</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Ks</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Eccentricity &amp; argument of periasteron</span>
    <span class="n">ecc</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">UnitUniform</span><span class="p">(</span>
        <span class="s2">&quot;ecc&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Angle</span><span class="p">(</span><span class="s2">&quot;omega&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Jitter &amp; a quadratic RV trend</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">yerr</span><span class="p">)),</span> <span class="n">sd</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;trend&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">10.0</span> <span class="o">**</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Then we define the orbit</span>
    <span class="n">orbit</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">orbits</span><span class="o">.</span><span class="n">KeplerianOrbit</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">ecc</span><span class="o">=</span><span class="n">ecc</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>

    <span class="c1"># And a function for computing the full RV model</span>
    <span class="k">def</span> <span class="nf">get_rv_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="c1"># First the RVs induced by the planets</span>
        <span class="n">vrad</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">get_radial_velocity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logK</span><span class="p">))</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;vrad&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">vrad</span><span class="p">)</span>

        <span class="c1"># Define the background model</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vander</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">x_ref</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;bkg&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">trend</span><span class="p">))</span>

        <span class="c1"># Sum over planets and add the background to get the full model</span>
        <span class="k">return</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;rv_model&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vrad</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">bkg</span><span class="p">)</span>

    <span class="c1"># Define the RVs at the observed times</span>
    <span class="n">rv_model</span> <span class="o">=</span> <span class="n">get_rv_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Also define the model on a fine grid as computed above (for plotting)</span>
    <span class="n">rv_model_pred</span> <span class="o">=</span> <span class="n">get_rv_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_pred&quot;</span><span class="p">)</span>

    <span class="c1"># Finally add in the observation model. This next line adds a new contribution</span>
    <span class="c1"># to the log probability of the PyMC3 model</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">yerr</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">logs</span><span class="p">))</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">rv_model</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, we can plot the initial model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.k&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xo</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">vrad_pred</span><span class="p">),</span> <span class="s2">&quot;--k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xo</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">bkg_pred</span><span class="p">),</span> <span class="s2">&quot;:k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xo</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">rv_model_pred</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time [days]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;radial velocity [m/s]&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;initial model&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span> <span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">blas</span><span class="p">):</span> <span class="n">We</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">find</span> <span class="n">a</span> <span class="n">dynamic</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">library_dir</span> <span class="n">of</span> <span class="n">the</span> <span class="n">library</span> <span class="n">we</span> <span class="n">use</span> <span class="k">for</span> <span class="n">blas</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">use</span> <span class="n">ATLAS</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">to</span> <span class="nb">compile</span> <span class="n">it</span> <span class="k">with</span> <span class="n">dynamics</span> <span class="n">library</span><span class="o">.</span>
<span class="n">WARNING</span> <span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">blas</span><span class="p">):</span> <span class="n">We</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">find</span> <span class="n">a</span> <span class="n">dynamic</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">library_dir</span> <span class="n">of</span> <span class="n">the</span> <span class="n">library</span> <span class="n">we</span> <span class="n">use</span> <span class="k">for</span> <span class="n">blas</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">use</span> <span class="n">ATLAS</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">to</span> <span class="nb">compile</span> <span class="n">it</span> <span class="k">with</span> <span class="n">dynamics</span> <span class="n">library</span><span class="o">.</span>
</pre></div>
</div>
<img alt="../../_images/rv_10_1.png" src="../../_images/rv_10_1.png" />
<p>In this plot, the background is the dotted line, the individual planets
are the dashed lines, and the full model is the blue line.</p>
<p>It doesn’t look amazing so let’s fit for the maximum a posterior
parameters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">map_soln</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">test_point</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">trend</span><span class="p">])</span>
    <span class="n">map_soln</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">map_soln</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">optimizing</span> <span class="n">logp</span> <span class="k">for</span> <span class="n">variables</span><span class="p">:</span> <span class="p">[</span><span class="n">trend</span><span class="p">]</span>
<span class="mi">12</span><span class="n">it</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">03</span><span class="p">,</span>  <span class="mf">3.51</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">logp</span><span class="o">=-</span><span class="mf">6.484820e+01</span><span class="p">]</span>
<span class="n">message</span><span class="p">:</span> <span class="n">Optimization</span> <span class="n">terminated</span> <span class="n">successfully</span><span class="o">.</span>
<span class="n">logp</span><span class="p">:</span> <span class="o">-</span><span class="mf">79.73266285618838</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mf">64.8482026233154</span>
<span class="n">optimizing</span> <span class="n">logp</span> <span class="k">for</span> <span class="n">variables</span><span class="p">:</span> <span class="p">[</span><span class="n">trend</span><span class="p">,</span> <span class="n">logs</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">ecc</span><span class="p">,</span> <span class="n">logK</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">t0</span><span class="p">]</span>
<span class="mi">93</span><span class="n">it</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">201.20</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">logp</span><span class="o">=-</span><span class="mf">1.427676e+01</span><span class="p">]</span>
<span class="n">message</span><span class="p">:</span> <span class="n">Optimization</span> <span class="n">terminated</span> <span class="n">successfully</span><span class="o">.</span>
<span class="n">logp</span><span class="p">:</span> <span class="o">-</span><span class="mf">64.8482026233154</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mf">14.276760262380932</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;vrad_pred&quot;</span><span class="p">],</span> <span class="s2">&quot;--k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;bkg_pred&quot;</span><span class="p">],</span> <span class="s2">&quot;:k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;rv_model_pred&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time [days]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;radial velocity [m/s]&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;MAP model&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/rv_13_0.png" src="../../_images/rv_13_0.png" />
<p>That looks better.</p>
</div>
<div class="section" id="sampling">
<h2>Sampling<a class="headerlink" href="#sampling" title="Permalink to this headline">¶</a></h2>
<p>Now that we have our model set up and a good estimate of the initial
parameters, let’s start sampling. There are substantial covariances
between some of the parameters so we’ll use a
<code class="xref py py-func docutils literal notranslate"><span class="pre">exoplanet.get_dense_nuts_step()</span></code> to tune the sampler (see the
<a class="reference internal" href="../pymc3-extras/#pymc3-extras"><span class="std std-ref">PyMC3 extras</span></a> tutorial for more information).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">tune</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
        <span class="n">draws</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
        <span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">chains</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">xo</span><span class="o">.</span><span class="n">get_dense_nuts_step</span><span class="p">(</span><span class="n">target_accept</span><span class="o">=</span><span class="mf">0.95</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">Multiprocess sampling (2 chains in 2 jobs)
NUTS: [trend, logs, omega, ecc, logK, P, t0]
Sampling 2 chains, 3 divergences: 100%|██████████| 16000/16000 [01:54&lt;00:00, 140.22draws/s]
There was 1 divergence after tuning. Increase <cite>target_accept</cite> or reparameterize.
There were 2 divergences after tuning. Increase <cite>target_accept</cite> or reparameterize.
The number of effective samples is smaller than 25% for some parameters.</pre>
<p>After sampling, it’s always a good idea to do some convergence checks.
First, let’s check the number of effective samples and the Gelman-Rubin
statistic for our parameters of interest:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span>
    <span class="n">trace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;trend&quot;</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="s2">&quot;omega&quot;</span><span class="p">,</span> <span class="s2">&quot;ecc&quot;</span><span class="p">,</span> <span class="s2">&quot;t0&quot;</span><span class="p">,</span> <span class="s2">&quot;logK&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hpd_3%</th>
      <th>hpd_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_mean</th>
      <th>ess_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>trend[0]</th>
      <td>0.001</td>
      <td>0.001</td>
      <td>-0.000</td>
      <td>0.002</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>4690.0</td>
      <td>4690.0</td>
      <td>4720.0</td>
      <td>5047.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>trend[1]</th>
      <td>-0.039</td>
      <td>0.022</td>
      <td>-0.081</td>
      <td>0.003</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>6301.0</td>
      <td>5991.0</td>
      <td>6362.0</td>
      <td>5583.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>trend[2]</th>
      <td>-1.991</td>
      <td>0.793</td>
      <td>-3.542</td>
      <td>-0.585</td>
      <td>0.011</td>
      <td>0.008</td>
      <td>5568.0</td>
      <td>5568.0</td>
      <td>5638.0</td>
      <td>5242.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>logs</th>
      <td>1.037</td>
      <td>0.223</td>
      <td>0.582</td>
      <td>1.424</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3193.0</td>
      <td>3193.0</td>
      <td>3237.0</td>
      <td>3956.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>omega[0]</th>
      <td>-0.285</td>
      <td>0.784</td>
      <td>-1.436</td>
      <td>1.292</td>
      <td>0.021</td>
      <td>0.016</td>
      <td>1433.0</td>
      <td>1215.0</td>
      <td>1705.0</td>
      <td>1254.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>omega[1]</th>
      <td>-0.645</td>
      <td>2.126</td>
      <td>-3.135</td>
      <td>2.885</td>
      <td>0.043</td>
      <td>0.030</td>
      <td>2495.0</td>
      <td>2495.0</td>
      <td>3891.0</td>
      <td>7147.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>ecc[0]</th>
      <td>0.238</td>
      <td>0.114</td>
      <td>0.019</td>
      <td>0.433</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>3106.0</td>
      <td>3106.0</td>
      <td>2999.0</td>
      <td>1980.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>ecc[1]</th>
      <td>0.196</td>
      <td>0.143</td>
      <td>0.000</td>
      <td>0.459</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>2764.0</td>
      <td>2764.0</td>
      <td>2539.0</td>
      <td>3093.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>t0[0]</th>
      <td>2072.795</td>
      <td>0.001</td>
      <td>2072.793</td>
      <td>2072.796</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>8058.0</td>
      <td>8058.0</td>
      <td>8061.0</td>
      <td>5554.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>t0[1]</th>
      <td>2082.625</td>
      <td>0.000</td>
      <td>2082.624</td>
      <td>2082.626</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>8114.0</td>
      <td>8114.0</td>
      <td>8117.0</td>
      <td>5931.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>logK[0]</th>
      <td>1.555</td>
      <td>0.254</td>
      <td>1.071</td>
      <td>1.990</td>
      <td>0.006</td>
      <td>0.004</td>
      <td>1882.0</td>
      <td>1882.0</td>
      <td>2577.0</td>
      <td>1737.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>logK[1]</th>
      <td>1.565</td>
      <td>0.233</td>
      <td>1.143</td>
      <td>2.009</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>2844.0</td>
      <td>2844.0</td>
      <td>3716.0</td>
      <td>2027.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>P[0]</th>
      <td>20.885</td>
      <td>0.000</td>
      <td>20.885</td>
      <td>20.886</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>7987.0</td>
      <td>7987.0</td>
      <td>7996.0</td>
      <td>6077.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>P[1]</th>
      <td>42.363</td>
      <td>0.001</td>
      <td>42.362</td>
      <td>42.364</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>7475.0</td>
      <td>7475.0</td>
      <td>7476.0</td>
      <td>5873.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div><p>It looks like everything is pretty much converged here. Not bad for 14
parameters and about a minute of runtime…</p>
<p>Then we can make a <a class="reference external" href="https://corner.readthedocs.io">corner plot</a> of
any combination of the parameters. For example, let’s look at period,
semi-amplitude, and eccentricity:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">corner</span>

<span class="n">samples</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">trace_to_dataframe</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;logK&quot;</span><span class="p">,</span> <span class="s2">&quot;ecc&quot;</span><span class="p">,</span> <span class="s2">&quot;omega&quot;</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/rv_19_0.png" src="../../_images/rv_19_0.png" />
<p>Finally, let’s plot the plosterior constraints on the RV model and
compare those to the data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.k&quot;</span><span class="p">)</span>

<span class="c1"># Compute the posterior predictions for the RV model</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;rv_model_pred&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">84</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pred</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
<span class="n">art</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pred</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">art</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time [days]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;radial velocity [m/s]&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;posterior constraints&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/rv_21_0.png" src="../../_images/rv_21_0.png" />
</div>
<div class="section" id="phase-plots">
<h2>Phase plots<a class="headerlink" href="#phase-plots" title="Permalink to this headline">¶</a></h2>
<p>It might be also be interesting to look at the phased plots for this
system. Here we’ll fold the dataset on the median of posterior period
and then overplot the posterior constraint on the folded model orbits.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">letter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s2">&quot;bc&quot;</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="c1"># Get the posterior median orbital parameters</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">][:,</span> <span class="n">n</span><span class="p">])</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">][:,</span> <span class="n">n</span><span class="p">])</span>

    <span class="c1"># Compute the median of posterior estimate of the background RV</span>
    <span class="c1"># and the contribution from the other planet. Then we can remove</span>
    <span class="c1"># this from the data to plot just the planet we care about.</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;vrad&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">other</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;bkg&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Plot the folded data</span>
    <span class="n">x_fold</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">p</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x_fold</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">other</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.k&quot;</span><span class="p">)</span>

    <span class="c1"># Compute the posterior prediction for the folded RV model for this</span>
    <span class="c1"># planet</span>
    <span class="n">t_fold</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">p</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">t_fold</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;vrad_pred&quot;</span><span class="p">][:,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">84</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_fold</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="n">pred</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
    <span class="n">art</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
        <span class="n">t_fold</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pred</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span>
    <span class="p">)</span>
    <span class="n">art</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;phase [days]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;radial velocity [m/s]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;K2-24</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">letter</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../../_images/rv_23_0.png" src="../../_images/rv_23_0.png" />
<img alt="../../_images/rv_23_1.png" src="../../_images/rv_23_1.png" />
</div>
<div class="section" id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Permalink to this headline">¶</a></h2>
<p>As described in the <a class="reference internal" href="../citation/#citation"><span class="std std-ref">Citing exoplanet &amp; its dependencies</span></a> tutorial, we can use
<a class="reference internal" href="../../user/api/#exoplanet.citations.get_citations_for_model" title="exoplanet.citations.get_citations_for_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">exoplanet.citations.get_citations_for_model()</span></code></a> to construct an
acknowledgement and BibTeX listing that includes the relevant citations
for this model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">txt</span><span class="p">,</span> <span class="n">bib</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">get_citations_for_model</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">This research made use of textsf{exoplanet} citep{exoplanet} and its
dependencies citep{exoplanet:astropy13, exoplanet:astropy18,
exoplanet:exoplanet, exoplanet:pymc3, exoplanet:theano}.</pre>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bib</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[:</span><span class="mi">10</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@misc</span><span class="p">{</span><span class="n">exoplanet</span><span class="p">:</span><span class="n">exoplanet</span><span class="p">,</span>
  <span class="n">author</span> <span class="o">=</span> <span class="p">{</span><span class="n">Daniel</span> <span class="n">Foreman</span><span class="o">-</span><span class="n">Mackey</span> <span class="ow">and</span> <span class="n">Rodrigo</span> <span class="n">Luger</span> <span class="ow">and</span> <span class="n">Ian</span> <span class="n">Czekala</span> <span class="ow">and</span>
            <span class="n">Eric</span> <span class="n">Agol</span> <span class="ow">and</span> <span class="n">Adrian</span> <span class="n">Price</span><span class="o">-</span><span class="n">Whelan</span> <span class="ow">and</span> <span class="n">Tom</span> <span class="n">Barclay</span><span class="p">},</span>
   <span class="n">title</span> <span class="o">=</span> <span class="p">{</span><span class="n">exoplanet</span><span class="o">-</span><span class="n">dev</span><span class="o">/</span><span class="n">exoplanet</span> <span class="n">v0</span><span class="o">.</span><span class="mf">3.1</span><span class="p">},</span>
   <span class="n">month</span> <span class="o">=</span> <span class="n">may</span><span class="p">,</span>
    <span class="n">year</span> <span class="o">=</span> <span class="mi">2020</span><span class="p">,</span>
     <span class="n">doi</span> <span class="o">=</span> <span class="p">{</span><span class="mf">10.5281</span><span class="o">/</span><span class="n">zenodo</span><span class="o">.</span><span class="mi">1998447</span><span class="p">},</span>
     <span class="n">url</span> <span class="o">=</span> <span class="p">{</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">doi</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="mf">10.5281</span><span class="o">/</span><span class="n">zenodo</span><span class="o">.</span><span class="mi">1998447</span><span class="p">}</span>
<span class="p">}</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
</div>

  <div class="t-pagination clearfix">
    <span>
      ← <a href="../pymc3-extras/" title="PyMC3 extras">PyMC3 extras</a>
    </span>
    <span style="float:right">
      <a href="../transit/" title="Transit fitting">Transit fitting</a> →
    </span>
  </div>


    </div>
<footer class="t-foot">
    &copy; Copyright 2018, 2019, 2020, Dan Foreman-Mackey.
    <br>
    A <a href="https://typlog.com/">typlog</a> <a href="https://github.com/typlog/sphinx-typlog-theme">sphinx theme</a>,
    designed by <a href="https://lepture.com/">Hsiaoming Yang</a>.
</footer>

<script id="versions-template" type="x-tmpl-mustache">
<div class="versions">
    <div class="current-version">
        v0.3.1
        <span class="fas fa-caret-down"></span>
    </div>
    <dl class="versions-dropdown">
        {{#versions}}
        <dd><a href="https://docs.exoplanet.codes/en/{{.}}/tutorials/rv">{{.}}</a></dd>
        {{/versions}}
    </dl>
</div>
</script>

  </div>
  <script>$(function(){$(".t-head_menu").on("click",function(){$("body").addClass("_expand")});$(".t-body").on("click",function(){$("body").removeClass("_expand")});$(".t-sidebar_close").on("click",function(){$("body").removeClass("_expand")});$("a.footnote-reference").on("click",function(e){e.preventDefault();var id=$(this).attr("href");var html=$(id).find("td.label + td").html();var w=Math.max(document.documentElement.clientWidth,window.innerWidth||0);var style="top:"+e.pageY+"px;";if(w>560){style+="width:480px;";if(e.pageX>240&&e.pageX+240<w){style+="left:"+(e.pageX-240)+"px;"}else if(e.pageX<=240){style+="left:20px;"}else{style+="right:20px;"}}showFootnote(html,style)});function showFootnote(html,style){var CONTENT_ID="typlog-footnote-content";var content=document.getElementById(CONTENT_ID);if(!content){content=document.createElement("div");content.id=CONTENT_ID;$(".t-body").append(content)}var MASK_ID="typlog-footnote-mask";var mask=document.getElementById(MASK_ID);if(!mask){mask=document.createElement("div");mask.id=MASK_ID;document.body.appendChild(mask);mask.addEventListener("click",function(){content.className="";mask.className=""})}content.innerHTML=html;content.setAttribute("style",style);content.className="_active";mask.className="_active"}function fetchGitHubRepo(repo){var url="https://api.github.com/repos/"+repo;$.getJSON(url,function(data){var counts=[+new Date,data.stargazers_count,data.forks_count];localStorage.setItem("gh:"+repo,JSON.stringify(counts));updateGitHubStats(counts[1],counts[2])})}function updateGitHubStats(stars,forks){$(".github_stars strong").text(stars);$(".github_forks strong").text(forks)}function initGitHub(url){if(!url){return}var repo=url.replace("https://github.com/","");var cache=localStorage.getItem("gh:"+repo);if(cache){try{var counts=JSON.parse(cache);updateGitHubStats(counts[1],counts[2]);var delta=new Date-counts[0];if(delta<0||delta>9e5){fetchGitHubRepo(repo)}}catch(error){fetchGitHubRepo(repo)}}else{fetchGitHubRepo(repo)}}initGitHub($(".github").attr("href"))});</script>
</body>
</html>